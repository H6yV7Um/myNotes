# 配置化设计思路

## 现有开发方式遇到的问题

对于超大型系统需求多, 链路长, 业务功能重复开发, 不方便管理.

### 全局视角下各业务域的需求管理机制

缺少全局视角会导致的问题

1. 相同业务需求重复建设
2. 需求不清楚
3. 业务方甚至开发者都没有足够了解当前系统能力
4. 系统能力没有完整展示的地方, 每次开发技术方案都要重新评估
5. 新人接手不便

### 系统越来越复杂, 废弃功能多, 接入新业务更改成本高

业务变化很快, 接入的越来越多, 废弃或停用的业务也越来越多

1. 废弃代码没有及时清除
2. 系统相互依赖, 修改一处处处受到影响. 修改成本高
3. 不方便小型业务的快速响应上线

### 定制业务与核心代码没有分离

一些定制的业务代码与核心代码耦合, 未分离, 项目整体的开发及回归成本非常高

### 业务代码资产可复用性低

相同或类似的业务流程是否能实现代码的快速复用.

## 解决思路

1. 业务代码与平台核心代码分离, 插件化结构
2. 不同业务之间完全隔离, 以实现不同业务的单独自由管理
3. 业务管理域与业务功能域分离

业务管理域指对当前业务的功能及配置项的管理, 以实现业务功能的可视化及可控化

### 平台与业务的合作及管理方式

#### 平台能力的开放

1. 平台通过对各个功能建模, 将自身的能力定义后外放, 各业务通过平台提供的配置项进行功能的定制. 
2. 在一个连贯的上下游链路中, 对能力的描述维度应保持一致.
3. 平台可以提供的能力应清晰可查, 业务方可以方便的查询并使用平台的能力
4. 当业务方使用平台的能力之后, 平台应自动为该业务生成相应的功能说明文档.
5. 为业务生成可视化的业务流程图, 自定义配置化能力, 配置项的版本化管理等能力. 


#### 平台开放之后的稳定性及监控

1. 稳定性. 不仅要保证平台的稳定性, 同时要为各业务的稳定性自动生成监控工具及保障手段
2. 快速回滚: 出现故障后能够快速回滚


## 配置化的层次

平台提供配置化的层次

1. 基础功能: 脚手架, 中间件等
2. 基本业务能力: 平台为各个不同的业务域整理输出功能点作为基础的业务能力
3. 解决方案: 由基础功能组合生成相应的解决方案
4. 业务定制: 将不同的解决方案组合而成一项具体的业务

## 实现配置化的2个基础类

要实现配置化, 由业务能力和配置化功能组合而成. 
因此由2种模型构成, 能力模型和配置模型

能力模型: 用于定义管理平台中各个业务功能相关的能力, 并将这些能力透出给配置管理平台, 可以由开发或运营人员选择相应的能力组建业务.

配置模型: 能力模型透出可以配置的功能点, 通过配置系统将这些功能点聚合, 生成一套确定的业务配置数据, 下发给业务系统运行. 

### 能力模型结构

1. 域 Domain

根据不同的业务功能, 将相关的业务功能聚合为某个集合(domain 域)
如对于外卖业务, 可以根据业务相关的流程分为商家域, 买家域, 菜谱域, 营销域, 下单域, 结算域, 订单域等等.
域的信息主要用于做分类聚合

2. 域服务 DomaimService

每个域都会对外提供一些服务, 比如商家域会提供商家信息维护, 商家商品信息管理, 商家订单管理等服务

3. 能力, 扩展点, 能力实例

扩展点挂载在能力上, 扩展之后的某个具体的能力称为能力实例.
如一个汽车可以对其增加倒车影像的扩展, 扩展之后的倒车能力为一个其能力实例

4. 配置项, 配置点, 配置指令

能力透出的配置项需要在一个配置平台上进行管理. 配置模型需要单独实现, 配置模型需要包括以下几方面的内容

- 配置项的可视化. 能够方便运营或技术人员看到所有的可配置项, 及不同配置对应的能力和对系统的影响. 因此系统的配置项需要通过配置模型透出给配置平台.
- 冲突解决: 当对多个配置点进行叠加配置时, 很容易出现规则的冲突. 那么当前的配置项会出现哪些冲突? 当冲突出现的时候, 如何解决冲突, 冲突解决的优先级是什么? 如对一个汽车进行配置时要提高速度, 增加动力, 又要保证安全增加质量会影响速度, 如何展示并解决配置项的冲突.

5. 配置项模板 template

配置项模板是该业务场景下所有的配置项的一个集合. 模板应该拥有唯一的 key, name及扩展点列表. 以及当前模板在该业务下是否生效的isEffective属性.

某个具体业务A要运行依赖该模板B, 但该模板B并不对应该业务A. 

模板是业务的必要非充分条件

6. 模板配置 templateConfig

模板配置由配置项及冲突优先级组成.

如

```javascript

{
	templateA: {
		configA: {
			extension1: '',
			extension2: '',
			priority: 100
		},
		configB: {
			extension1: '',
			extension2: '',
			priority: 200
		}
	}
}

```

## 业务

业务是一种通过为他人提供商品或服务, 以换取利润或产品, 服务的一种行为.

### 业务运营

对于公司而言, 做业务的核心目的是要降低成本, 提高利润. 
因此公司做组织架构设计, 业务规划, 业务运营都会围绕这2个目的来进行优化.

### 业务定义的维度

根据业务方向的不同分为垂直方向和水平方向

1. 垂直方向

垂直方向是在某个具体的行业内进行深耕发展的业务, 即形形色色的行业, 如建材, 生鲜, 时装, 五金, 化工等. 

不同行业间的业务形态差距很大, 因此是没有办法完全套用的. 

2. 水平方向

水平方向即类似平台这样的, 为不同行业提供通用的解决方案的业务, 如电商平台或者某些促销频道 可以卖各个行业的产品. 
水平方向的业务为了体验的一致性通常会要求尽量多的通用性. 

当垂直方向的业务要接入某个水平方向的业务时, 会遇到一些冲突.

如生鲜行业要求尽快的送达, 而建材行业通常会预定产品, 安装的时间可能会在几个月以后. 如果接入同一个平台的时候对于平台来说如何兼容解决这些冲突是对平台能力的考验. 

- 水平业务会对垂直业务的规则产生变更
- 多个水平业务可以叠加到同一个垂直业务上. 
- 通常一个业务会由一个垂直业务+n个水平业务这样的形态组成. 

3. 业务的叠加

同一个垂直业务可以叠加在多个水平业务上. 如一个建材品牌可以同时参加618, 线下订货会, 店内满减等多种活动. 

冲突的处理: 

3.1 reduce规则冲突解决

对于同时参加多种活动遇到不同的规则冲突时如何处理?
如618平台要求满5000元8折, 店内活动是满2件7折, 遇到这种规则冲突时可以采用reduce算法, 看下哪种规则的最后价格最低就采用哪种规则

3.2 排他性规则冲突的解决

如店内已设置折扣的商品不能使用平台优惠券, 遇到这种冲突可以提前设置优先级, 按优先级进行冲突的处理


## 基于能力的可视化平台

系统的能力需要一个可视化的平台透出, 可以供开发, 测试, 运营等相关人员方便查看系统能力. 减少沟通, 协作成本. 

该平台需要提供的能力包括

- 可视化, 基于业务功能的配置点的可视化
- 业务的结构化分解, 根据经验及系统能力对业务进行结构化分解
- 系统配置, 根据需求对系统进行配置设置
- 测试一体化, 更改配置项后自动完成测试
- 系统监控, 完成对整个系统的监控
- 故障排查, 出现故障后能够尽快定位故障, 并能实现一定程度的故障自动修复






































