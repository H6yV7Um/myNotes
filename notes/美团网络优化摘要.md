# 美团网络优化

## 网络中的主要问题

- 网络不可用
  - GFW
  - DNS劫持
  - 网络基础设施问题
- 网络慢, 加载时间长
  - 移动设备启动需要预热并打开通信芯片
  - 跨运营商, 物理路径长
  - http请求基于socket设计, 需要三次握手, 四次挥手.
- 数据安全问题
  - http请求容易被抓包. post请求可以加密body数据, 但是header和url依然是暴漏的, https也会遇到一样的问题.
  - 运营商劫持.

## 短连方案优化

### 方案一: 域名合并

美团APP中涉及许多业务方, 有大量的不同的三级域名. 
将所有的三级域名合并为一个域名, 在客户端将所有的三级域名转换为同一个发到同一个服务端, 到服务端再以同样的规则解码并分发到正确的地址.

**收益**

- 域名收编, 减少dns请求次数, 降低dns劫持的风险
- 针对同一域名, 通过keep-alive复用http链接通道
- 客户端业务层不需要修改代码，后端业务服务也不需要进行任何修改。

### 方案二: IP直连方案

经过域名合并, 将域名收编为同一个.
针对该域名在客户端设置dns解析规则.

方案很简单：程序启动的时候拉取"api.dianping.com"对应的所有的IP列表；对所有IP进行跑马测试，找到速度最快的IP。后续所有的HTTPS请求都将域名更换为跑马最快的IP即可。

**ip直连优势** 

- 绕开传统的dns, 解决dns干扰.
- 自建dns更新时机可控.
- ip列表更换方案.

## 长连通道建设

通过代理长连服务器代理客户端到业务服务器的连接. 

- 对DNS无依赖。客户端与代理服务器之间的长连通道是通过IP建立的，与DNS没有关系。客户端的HTTP请求被转换为二进制数据流送到代理服务器，也不需要进行DNS解析。代理服务器转发请求到业务服务器时，都处于同一内网，因此可以自己搭建DNS服务，减少对公网DNS服务的依赖。从这个层面上说，代理长连模式天生具有防DNS劫持的能力。
- 不同域名的请求可以复用同一条长连通道。
- 通道易优化。与部署业务服务器相比，部署代理长连服务器的代价就小了很多，可以在全国甚至全世界多地部署代理长连服务器。客户端在选择代理长连服务器时，可以通过跑马找到最快的服务器IP进行连接。另一方面，代理服务器与业务服务器之间的网络通道也可以进行优化，通过架设专线或者租用腾讯云等方式可以大大提升通道服务质量。
- 对业务完全透明。客户端的业务代码只要接入网络层的SDK即可，完全不用关心网络请求使用的是长连通道还是短连通道。代理服务器将客户端的请求还原为HTTP短连方式送到业务服务器，业务服务器不需要进行任何改造。
- 网络协议完全自定义。

初期采用了腾讯的维纳斯（WNS）服务


